<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="/avatar.jpg"/><link rel="stylesheet" href="/_next/static/css/89fdb76f795b0797.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-6bf358eca9a0310b.js"/><script src="/_next/static/chunks/4bd1b696-db28424fe4d701e0.js" async=""></script><script src="/_next/static/chunks/517-3340d5ffba85f04d.js" async=""></script><script src="/_next/static/chunks/main-app-431dcfd7004f3945.js" async=""></script><script src="/_next/static/chunks/4bd22374-02665d04d05c313a.js" async=""></script><script src="/_next/static/chunks/173-546eff084523247c.js" async=""></script><script src="/_next/static/chunks/541-6f08d634a9ccc7b8.js" async=""></script><script src="/_next/static/chunks/699-55b59e7c528efd79.js" async=""></script><script src="/_next/static/chunks/app/cyber/blog/manual-unpacking-upx-and-mpress/page-c6c8d40c14cfeecf.js" async=""></script><link rel="icon" href="/avatar.jpg"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="Wrapper"><div><div class="burger-menu">☰ <!-- -->            </div><div class="sidebarLeft "><div class="avatar"><img src="/avatar.jpg" alt="Avatar"/></div><ul><a href="/"><li>Search</li></a><a href="/cyber/writeup/"><li>Writeups</li></a><a href="/cyber/blog/"><li>Blog</li></a><a href="/cyber/tags/"><li>Tags</li></a><a href=""><li style="color:#555555">Resources</li></a><a href=""><li style="color:#555555">Cheat sheets</li></a></ul></div></div><div class="content"><div class="Post"><div><div id="Manual-Unpacking-of-UPX-and-MPRESS"><div><h1> <span style="color:#da1953">Man</span>ual Unpacking UPX and MPRESS </h1><hr></div><div id="banner"><div><img src="/cyber/blog/upxmpress/banner.webp" alt=""></div></div><div id="Introduction"><div><hr><h2><span style="color:#da1953">Int</span>roduction</h2></div><div><blockquote><p><em>“Packing is a technique to hide the original code of a program through one or more layers of compression and/or encryption. Used by malware writers to make static analysis harde, to hide from certain antivirus products via polymorphism (diversity), as packers are used to shrink benevolent programs, they cannot be banned! In-depth analysis of packed malware usually starts in a debugger: in other words, we must unpack the sample…"</em></p></blockquote></div><div><p>The tools I am going to use are:</p></div><div><ul><li>PEStudio</li><li>Detect It Easy</li><li>IDA (Free)</li><li>Scylla</li></ul><br></div></div><div id="Packing-Indicators"><div><h2> <span style="color:#da1953">Pac</span>king Indicators </h2></div><div><p>Before doing the unpacking I have to understand if the binary is packed or not and to do this I will use two tools in particular, <strong>Detect It Easy</strong> and <strong>PEStudio</strong>.</p></div><div><p>I load the binary with <strong>Detect It Easy</strong> to see what information it gives to me.</p></div><div><p><img src="/cyber/blog/upxmpress/image15.png" alt=""></p></div><div><p><strong>Detect It Easy</strong> tells me that it is packed with <strong>UPX</strong> and it also tell the version (3.93), another useful information is the number of sections, to check it is accuracy I also check entropy.</p></div><div><p><img src="/cyber/blog/upxmpress/image17.png" alt=""></p></div><div><p>I check it to be sure that it’s packed, sometimes it could show that the binary is not packed but it has a high level of entropy which is a good indication of packing.</p></div><div><p>I also need to check the type of the binary (<strong>H</strong>-hexadecimal key in the main window of <strong>Detect It Easy</strong>), even if I know it, I have to be sure.</p></div><div><p>(<strong>MZ</strong>) These two characters indicate that the binary is a <strong>PE</strong> (Portable Executable) but they might get changed by the attacker, in this case by viewing the number of next bytes I can detect if it’s really a <strong>PE</strong> or not.</p></div><div><p><img src="/cyber/blog/upxmpress/image32.png" alt=""></p></div><div><p>Now I go to <strong>PEStudio</strong> to see what information I can collect and if it also confirms that it is packed.</p></div><div><p>The first thing I am going to check is the size of the binary to get an idea of ​​who am I dealing with.</p></div><div><p>If the file is very large it cannot have few imports while for a small file it is plausible but it is not said therefore not to trust is better.</p></div><div><p><img src="/cyber/blog/upxmpress/image14.png" alt=""></p></div><div><p>Here, in addition to the file size, I also see the entropy (7,114) which is very high equal to <strong>Detect It Easy</strong> and therefore it seems that it is packed. I also have the signature confirming that it is packed with UPX.</p></div><div><p>Now I check the sections, in particular <em>&ldquo;Virtual-Size&rdquo;</em> and <em>&ldquo;Raw-Size&rdquo;</em> of the sections. if at last in one of them the difference is so high it’s a good indicator of packing.</p></div><div><p>If at least one section has a very high entropy then it is another good indicator of packing (MAX-Entropy: 8), also if at least one section has <strong>WX</strong> (Writable and Executable) permission is also an indicator of packing.</p></div><div><p><img src="/cyber/blog/upxmpress/image4.png" alt=""></p></div><div><p>Now I check the imports, if the imports are so few it’s a good indicator of packing, if <em>“GetProcess”</em> and <em>“LoadLibraryA”</em> are the only imports shown in the PEStudio then it is sure that the binary is packed.</p></div><div><p><img src="/cyber/blog/upxmpress/image31.png" alt=""></p></div><div><p>In this case I have too few imports, there are cases where only the two imports mentioned above are shown.</p></div><div><p>At last I search the strings in search of the packer’s name, to make the search easier I ordered the strings in descending order.</p></div><div><p><img src="/cyber/blog/upxmpress/image18.png" alt=""></p></div><div><p>Now that I am sure that the binary is packed I will show how to unpack in the two cases where it is packed with MPRESS and the case where it is packed with UPX.</p></div><div><p>For the first part I used a packed binary with UPX but the results of <strong>PEStudio</strong> and <strong>Detect It Easy</strong> would be almost identical if the file had been packed with MPRESS.</p></div><div></div></div><div id="Manual-Unpacking-of-UPX"><div><h2> <span style="color:#da1953">Man</span>ual Unpacking of UPX </h2></div><div><p>To do the unpacking I use <strong>IDA</strong>, any version is fine in my case it is <strong>IDA Free</strong> and I load the binary as <strong>PE</strong>.</p></div><div><p><img src="/cyber/blog/upxmpress/image25.png" alt=""></p></div><div><p>Once the binary is loaded, <strong>IDA</strong> warns me that some imports are not visible and that <strong>IAT</strong> (Import Address Table) is located outside the memory range and this further confirms that the binary is packed.</p></div><div><p><img src="/cyber/blog/upxmpress/image20.png" alt=""></p></div><div><p>To unpack <strong>UPX</strong> I have to look for a <em>&ldquo;tail jump&rdquo;</em>, it is called <em>&ldquo;tail jump&rdquo;</em> because it is usually at the end of the program. This jump has a peculiarity therefore jump from one section to another and therefore it is a very long jump.</p></div><div><p><img src="/cyber/blog/upxmpress/image13.png" alt=""></p></div><div><p>Here I have a jump in the <strong>UPX1</strong> section which goes to another section and jumps to address <strong>402284</strong>.</p></div><div><p><img src="/cyber/blog/upxmpress/image22.png" alt=""></p></div><div><p>In fact I see that the address <strong>402284</strong> is in the <strong>UPX0</strong> section and there are no other jumps of this type so I can conclude that I have found the tail jump.</p></div><div><p>At this point I put a breakpoint at address <strong>402284</strong> and run the binary and this message confirms once again that the binary is packed.</p></div><div><p><img src="/cyber/blog/upxmpress/image26.png" alt=""></p></div><div><p>Select <em>“yes”</em>.</p></div><div><p>After the execution the code has changed, now I can see the code that was hidden / compressed inside it.</p></div><div><p><img src="/cyber/blog/upxmpress/image11.png" alt=""></p></div><div><p>I am on a <em>&ldquo;call&rdquo;</em> statement, where I should really be. At this point I can use both the address of the jump instruction (<strong>402284</strong>) and the address to which it jumps (<strong>402558</strong>) as <strong>OEP</strong> (Original Entry Point) and in both addresses they work fine.</p></div><div><p>In order to unpack I use <strong>Scylla</strong> and in the <strong>OEP</strong> field I write one of the two addresses.</p></div><div><p><strong><strong>During these operations I must leave IDA running in debug I cannot close it.</strong></strong></p></div><div><ol><li>I select the process of IDA running the sample.</li><li>I insert in the OEP field the address found on IDA.</li><li>Click “IAT Autosearch”</li></ol></div><div><p>And it would successfully find the start address and the size. <em><strong>If not it is a good practice to to restart every time Scylla because its buggy</strong></em>.</p></div><div><p><img src="/cyber/blog/upxmpress/image10.png" alt=""></p></div><div><p>At this point I can get the imports simply by clicking <em>&ldquo;Get Imports&rdquo;</em>.</p></div><div><p><img src="/cyber/blog/upxmpress/image30.png" alt=""></p></div><div><p>84 imports were found, since I own the unpacked binary I can double check if the found imports are correct.</p></div><div><p><img src="/cyber/blog/upxmpress/image19.png" alt=""></p></div><div><p>In fact <strong>PEStudio</strong> tells me that the unpacked binary has 84 imports so my process has been successful.</p></div><div><p>To create the unpacked binary, I click on <em>&ldquo;Dump&rdquo;</em> and save the file.</p></div><div><p><img src="/cyber/blog/upxmpress/image34.png" alt=""></p></div><div><p>Now just I click on <em>&ldquo;Fix Dump&rdquo;</em> and choose the dump created previously to create the unpacked binary.</p></div><div><p><img src="/cyber/blog/upxmpress/image29.png" alt=""></p></div><div><p>To make a further check, I load the new binary with <strong>PEStudio</strong>.</p></div><div><p><img src="/cyber/blog/upxmpress/image9.png" alt=""></p></div><div><p>Here I can see the difference between the original packed binary and the unpacked binary created by me.</p></div><div><p>The first thing I notice is the size of my file is much larger, which I expected, while the imports of my binary are 0 but this is not a problem because it is a problem during the creation of the new binary with <strong>Scylla</strong> , as long as <strong>Shylla</strong> has found the imports correctly there are no problems even if <strong>PEStudio</strong> does not show them, lastly I see that there are many more strings than before.</p></div><div><p>And this concludes the manual unpacking of a packed binary with <strong>UPX</strong>.</p></div><div></div></div><div id="Manual-Unpacking-of-MPRESS"><div><h2 id=MANUNPACMPRESS> <span style="color:#da1953">Man</span>ual Unpacking of MPRESS </h2></div><div><p>The identification of a packed binary with <strong>MPRESS</strong> is identical to that of <strong>UPX</strong> shown above. Loading the binary with <strong>IDA</strong> tells me directly that maybe it is packed.</p></div><div><p><img src="/cyber/blog/upxmpress/image2.png" alt=""></p></div><div><p>Once the binary is loaded I should be faced with a <em>pusha</em> instruction, if this were not the case, just select the start function and put a breakpoint.</p></div><div><p><img src="/cyber/blog/upxmpress/image21.png" alt=""></p></div><div><p>Now I run the binary paying particular attention to the <em>Stack View</em> window (down right corner window).</p></div><div><p><img src="/cyber/blog/upxmpress/image5.png" alt=""></p></div><div><p>I step over once and notice that the addresses on the stack have changed.</p></div><div><p><img src="/cyber/blog/upxmpress/image7.png" alt=""></p></div><div><p>Now the stack points to start, I step over until I come back again on the start, since the start on the stack appears twice once at <strong>9FF64</strong> and once at <strong>9FF68</strong>.</p></div><div><p>In my case it was enough for me to do <em>Step Over</em> twice.</p></div><div><p><img src="/cyber/blog/upxmpress/image1.png" alt=""></p></div><div><p>Note that I started from <em>pusha</em> instruction at <strong>4512D7</strong> and now I am at <strong>4512DE</strong>.</p></div><div><p>Now I right click on the stack address <strong>19FF64</strong> and follow in hex dump.</p></div><div><p><img src="/cyber/blog/upxmpress/image36.png" alt=""></p></div><div><p>The <em>Hex View-1</em> window will change and a byte will be highlighted.</p></div><div><p><img src="/cyber/blog/upxmpress/image16.png" alt=""></p></div><div><p>Now I select the four bytes (DWORD) starting from <strong>D7</strong> and put a breakpoint on it which will be a hardware breakpoint with read and write permission (WR), the permissions <strong>WR</strong> will be set automatically but it is possible to view the breakpoint and modify it but in this case is not needed.</p></div><div><p><img src="/cyber/blog/upxmpress/image3.png" alt=""></p></div><div><p>Now I run the binary with the <em>Play</em> button and I will hit the hardware breakpoint.</p></div><div><p><img src="/cyber/blog/upxmpress/image28.png" alt=""></p></div><div><p>and <strong>IDA</strong> will detect that <strong>RIP</strong> point is not in a defined address same as for <strong>UPX</strong>.</p></div><div><p><img src="/cyber/blog/upxmpress/image8.png" alt=""></p></div><div><p>Upon pressing <em>Yes</em> the code will change and I’m suddenly in a <em>call</em> instruction and I step into, <strong>IDA</strong> will tell me again the same message about <strong>RIP</strong> pointing in an undefined address.</p></div><div><p>I can’t use the address of <em>call</em> instruction (402BA6) as I did for <strong>UPX</strong> but I have to use the address pointed by the <em>call</em> instruction (401B54).</p></div><div><p><img src="/cyber/blog/upxmpress/image24.png" alt=""></p></div><div><p>And the address <strong>401B54</strong> is my <strong>OEP</strong> which I will use in <strong>Scylla</strong> to unpack it.</p></div><div><p>Once found the <strong>OEP</strong> the unpacking process will be identical to <strong>UPX</strong> but for completeness I rewrite it anyway.</p></div><div><p>Remember to restart <strong>Scylla</strong> every time because it’s buggy. Also here I can’t close the <strong>IDA</strong> process which is in debugging.</p></div><div><p>In order to unpack I follow the same steps as for <strong>UPX</strong>.</p></div><div><ol><li>I select the process of <strong>IDA</strong> running the sample.</li><li>I insert in the <strong>OEP</strong> field the address found on <strong>IDA</strong>.</li><li>Click <em>“IAT Autosearch”</em></li></ol></div><div><p>And it would successfully find the <em>start</em> address and the size.</p></div><div><p><img src="/cyber/blog/upxmpress/image23.png" alt=""></p></div><div><p>At this point we can get the imports simply by clicking <em>&ldquo;Get Imports&rdquo;</em>.</p></div><div><p><img src="/cyber/blog/upxmpress/image6.png" alt=""></p></div><div><p>68 imports were found, since I own the unpacked binary also for this I can double check if the found imports are correct.</p></div><div><p><img src="/cyber/blog/upxmpress/image35.png" alt=""></p></div><div><p>In fact <strong>PEStudio</strong> tells me that the unpacked binary has 68 imports so my process has been successful.</p></div><div><p>To create the unpacked binary, click on <em>&ldquo;Dump&rdquo;</em> and save the file.</p></div><div><p><img src="/cyber/blog/upxmpress/image12.png" alt=""></p></div><div><p>Now just click on <em>&ldquo;Fix Dump&rdquo;</em> and choose the dump created previously to create the unpacked binary.</p></div><div><p><img src="/cyber/blog/upxmpress/image33.png" alt=""></p></div><div><p>To make a further check, I load the new binary with <strong>PEStudio</strong>.</p></div><div><p><img src="/cyber/blog/upxmpress/image27.png" alt=""></p></div><div><p>Here I can see the differences between the original packed binary and the unpacked binary created by me.</p></div><div><p>Much like <strong>UPX</strong>, even here the same values change even if the change is not much.</p></div><div><p>The unpacked version with <strong>Scylla</strong> has 0 imports, same as the <strong>UPX</strong> it’s not a problem as long as during the process <strong>Scylla</strong> found all the imports.</p></div><div><p>This conclude the manual unpacking of binaries packed with MPRESS.</p></div><div></div></div></div> </div></div></div><div class="sidebarRight"><div class="sidebarRightChild"><h2>Index</h2><div></div><br/><h2>Tags</h2><div class="tags"><a style="margin-top:10px" href="/cyber/tags/?searchTag=malware"><my-tag>malware</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=reverse+engineering"><my-tag>reverse engineering</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=security"><my-tag>security</my-tag></a></div></div></div></div><script src="/_next/static/chunks/webpack-6bf358eca9a0310b.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[5244,[],\"\"]\n3:I[3866,[],\"\"]\n4:I[3108,[\"667\",\"static/chunks/4bd22374-02665d04d05c313a.js\",\"173\",\"static/chunks/173-546eff084523247c.js\",\"541\",\"static/chunks/541-6f08d634a9ccc7b8.js\",\"699\",\"static/chunks/699-55b59e7c528efd79.js\",\"634\",\"static/chunks/app/cyber/blog/manual-unpacking-upx-and-mpress/page-c6c8d40c14cfeecf.js\"],\"default\"]\n5:I[5897,[\"667\",\"static/chunks/4bd22374-02665d04d05c313a.js\",\"173\",\"static/chunks/173-546eff084523247c.js\",\"541\",\"static/chunks/541-6f08d634a9ccc7b8.js\",\"699\",\"static/chunks/699-55b59e7c528efd79.js\",\"634\",\"static/chunks/app/cyber/blog/manual-unpacking-upx-and-mpress/page-c6c8d40c14cfeecf.js\"],\"default\"]\n6:I[8845,[\"667\",\"static/chunks/4bd22374-02665d04d05c313a.js\",\"173\",\"static/chunks/173-546eff084523247c.js\",\"541\",\"static/chunks/541-6f08d634a9ccc7b8.js\",\"699\",\"static/chunks/699-55b59e7c528efd79.js\",\"634\",\"static/chunks/app/cyber/blog/manual-unpacking-upx-and-mpress/page-c6c8d40c14cfeecf.js\"],\"default\"]\n7:I[6213,[],\"OutletBoundary\"]\n9:I[6213,[],\"MetadataBoundary\"]\nb:I[6213,[],\"ViewportBoundary\"]\nd:I[4835,[],\"\"]\n:HL[\"/_next/static/css/89fdb76f795b0797.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"UvOo7xTvD59yqHFsG_pYX\",\"p\":\"\",\"c\":[\"\",\"cyber\",\"blog\",\"manual-unpacking-upx-and-mpress\",\"\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"cyber\",{\"children\":[\"blog\",{\"children\":[\"manual-unpacking-upx-and-mpress\",{\"children\":[\"__PAGE__\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[\"$\",\"div\",null,{\"children\":[\"$\",\"center\",null,{\"children\":[\"Page not found\",[\"$\",\"br\",null,{}],\"You have followed and old link that does not work anymore\",[\"$\",\"br\",null,{}],\"The site has migrated from React app to NextJS app\"]}]}]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]]}],{\"children\":[\"cyber\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"cyber\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"cyber\",\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"manual-unpacking-upx-and-mpress\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"cyber\",\"children\",\"blog\",\"children\",\"manual-unpacking-upx-and-mpress\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[[\"$\",\"div\",null,{\"className\":\"Wrapper\",\"children\":[[\"$\",\"$L4\",null,{}],[\"$\",\"div\",null,{\"className\":\"content\",\"children\":[\"$\",\"div\",null,{\"className\":\"Post\",\"children\":[\"$\",\"$L5\",null,{\"postname\":\"blogdb/manual-unpacking-upx-and-mpress.json\"}]}]}],[\"$\",\"$L6\",null,{\"postname\":\"blogdb/manual-unpacking-upx-and-mpress.json\"}]]}],[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/89fdb76f795b0797.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L7\",null,{\"children\":\"$L8\"}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"4PBis20Dh9US8jqzPUu67\",{\"children\":[[\"$\",\"$L9\",null,{\"children\":\"$La\"}],[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\na:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"link\",\"1\",{\"rel\":\"icon\",\"href\":\"/avatar.jpg\"}]]\n"])</script><script>self.__next_f.push([1,"8:null\n"])</script></body></html>