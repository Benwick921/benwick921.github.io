<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="/avatar.jpg"/><link rel="stylesheet" href="/_next/static/css/89fdb76f795b0797.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-6bf358eca9a0310b.js"/><script src="/_next/static/chunks/4bd1b696-db28424fe4d701e0.js" async=""></script><script src="/_next/static/chunks/517-3340d5ffba85f04d.js" async=""></script><script src="/_next/static/chunks/main-app-431dcfd7004f3945.js" async=""></script><script src="/_next/static/chunks/4bd22374-02665d04d05c313a.js" async=""></script><script src="/_next/static/chunks/173-546eff084523247c.js" async=""></script><script src="/_next/static/chunks/541-ed6782f5dfc7fbce.js" async=""></script><script src="/_next/static/chunks/699-ca7eb7733d3ff9ab.js" async=""></script><script src="/_next/static/chunks/app/cyber/writeup/threat-hunting-with-yara/page-59e96a94b9ce46ef.js" async=""></script><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="Wrapper"><div><div class="burger-menu">☰ <!-- -->            </div><div class="sidebarLeft "><div class="avatar"><img src="/avatar.jpg" alt="Avatar"/></div><ul><a href="/"><li>Search</li></a><a href="/cyber/writeup/"><li>Writeups</li></a><a href="/cyber/blog/"><li>Blog</li></a><a href="/cyber/tags/"><li>Tags</li></a><a href=""><li style="color:#555555">Resources</li></a><a href=""><li style="color:#555555"><s>Contact</s></li></a></ul></div></div><div class="content"><div class="Post"><div><div id=""><div><h1><span style="color:#da1953">Thr</span>eat Hunting With YARA<hr></div><div id="banner"><div><img src="/cyber/writeup/threathuntingwithyara/banner.gif" alt=""></div><div><p>This is a summary of the room <em>Threat Hunting with YARA</em> on Try Hack Me</p></div></div><div id="Introduction"><div><hr><h1><span style="color:#da1953">Int</span>roduction</h1></div><div id="Learning-Objectives"><div><h2>Learning Objectives</h2></div><div><p><ul><li>Looking for actionable information that can be used to search for threats</li><li>Installing YARA</li><li>Creating a YARA rule</li><li>Deploying a YARA rule</li></ul></p></div></div><div id="Prerequisites"><div><h2>Prerequisites</h2></div><div><p><ul><li>Basic understanding of security concepts including but not limited to Cyber Kill Chain, TTPs, Indicator of Compromise, Hashes, and APTs.</li><li>Basic understanding of using the Windows command line and PowerShell.</li><li>Basic understanding of data types and encoding.</li></ul></p></div></div><div id="Answer-the-question-below-pt.1"><div><h2>Answer the question below</h2></div><div><p><b>Q:</B><i> What technique does ID T1134 describe?</i><br><b>A:</b> <i>Access Token Manipulation</i></p></div><div><p><b>Q:</b> <i>What does the detection rule M_APT_Dropper_Rootsaw_Obfuscated detect?</i><br><b>A:</b> <i>Detects obfuscated ROOTSAW payloads</i></p></div></div></div><div id="Opportunities-for-Threat-Hunting"><div><h1><span style="color:#da1953">Opp</span>ortunities for Threat Hunting</h1></div><div><p>There are mainly 3 types of Threat Hunting: Structured, Unstructured and Situational and they employed depending on the situation.</p></div><div><p><img src="/cyber/writeup/threathuntingwithyara/2b3ab1f4cb664f8d86e450d8dac29909.png"></p></div><div id="Structured-Hunting"><div><h2>Structured Hunting</h2></div><div><p>This approach starts with a plan or hypothesis based on known attacker behaviors and strategies. You’re looking for specific patterns or signs that show an attack might be starting.</p></div><div><p>How it works:</p></div><div><p><ul><li>Searches are powered by tools like YARA rules (to find patterns) or queries in a SIEM (to analyze logs).</li><li>Relies on external sources, like ecurity blogs or platforms that share attack details (e.g., MISP or AlienVault).</li></ul></p></div><div><p>Why it’s useful:</p></div><div><p><ul><li>It’s good for investigating after a possible compromise or when new threats are reported.</li></ul><p>Example:</p><ul><li>List itemFinding alware on a server after reading a blog about a similar attack.</li></ul></p></div></div><div id="Situational/Entity-Driven-Hunting"><div><h2>Situational/Entity-Driven Hunting</h2></div><div><p>This combines the first two approaches and focuses on what’s relevant right now for your organization. It responds to new threats or specific situations, like industry-specific risks or targeted reports.</p></div><div><p>How it works:</p></div><div><p><ul><li>Starts with a hypothesis about who might attack and what they’ll target.</li><li>Focuses on protecting your most critical assets (e.g., financial data or customer info).</li><li>Uses tools like the MITRE ATT&amp;CK framework and past attack data.</li></ul></p></div><div><p>Why it’s good:</p></div><div></p><ul><li>List itemIt adapts to current threats, making it highly focused and relevant.</li></ul><p>Example:</p><ul><li>If your industry is being targeted by a ransomware group, you look for signs of their activity in your systems.</li></ul></p></div></div></div><div id="Threat-Hunting-Process"><div><h1><span style="color:#da1953">Thr</span>eat Hunting Process</h1></div><div><p><img src="/cyber/writeup/threathuntingwithyara/939f0f2ec8f84feb9ff6d25823dd5d5e.png"></p></div><div id="Trigger"><div><h2>Trigger</h2></div><div><p>This is what starts the hunt for a security threat. A trigger could be:</p></div><div><p><ul><li>A warning sign, like a suspicious file (IOC).</li><li>A known behavior or method used by attackers (TTPs).</li><li>An educated guess (hypothesis).</li><li>A system acting strangely.</li><li>Information from blogs, news, or reports from other companies.</li></ul></p></div></div><div id="Investigation"><div><h2>Investigation</h2></div><div><p>Once you pick a trigger, you use it to start searching for problems.</p></div><div><p><ul><li>List itemSecurity experts use tools like malware scanners, network tools (e.g., Wireshark), or rules (like YARA) to find anything unusual in the systems or files.</li></ul></p></div></div><div id="Resolution"><div><h2>Resolution</h2></div><div><p>If evidence of a security breach is found:</p></div><div><p><ul><li>The incident response (IR) team is informed to handle the problem.</li><li>The threat hunter may help the IR team investigate further, find the root cause, and figure out how bad the damage is.</li></ul></p></div></div><div id="Opportunities"><div><h2>Opportunities</h2></div><div><p>How to apply the above scenarios:</p></div><div><p>Example: The received threat intelligence details specific TTPs attributed to APT29, which is known to target political entities. This intelligence enables a structured hunting style using the TTPs included in the report to build a hypothesis.</p></div><div><p>Example: The received threat intel includes Indicators of Compromise and YARA rules to hunt for malware. This intelligence enables an unstructured hunting style using the IOCs provided.</p></div><div><p>The two opportunities above can be combined to enable a situational or entity-driven hunting style.</p></div></div><div id="Answer-the-questions-below-pt.2"><div><h2>Answer the questions below</h2></div><div><p><b>Q:</b> <i>Which threat hunting style is proactive and uses indicators of attack and TTPs?</i><br><b>A:</b> <i>structured hunting</i></p></div><div><p><b>Q:</b> <i>In which phase of the threat hunting process, tools like YARA or Volatility are used?</i><br><b>A:</b> <i>Investigation</i></p></div><div><p><b>Q:</b> <i>You have received a threat intelligence report consisting only of Indicators of Compromise. What threat hunting style do you recommend to use?</i><br><b>A:</b> <i>unstructured hunting</i></p></div></div></div><div id="YARA-Rule-Introduction"><div><h1><span style="color:#da1953">YAR</span>A Rule Introduction</h1></div><div><p>YARA stands for Yet Another Ridiculous Acronym. It is a tool Victor Alvarez of VirusTotal developed to assist malware researchers in detecting and describing malware families. The main functionality of YARA is based on advanced pattern matching, explicitly tailored to malware. It can be best compared to using a supercharged grep with complex regular expressions in Linux. Just like the grep command, the YARA binary will iterate over all files in a designated path, trying to find a match with the information provided in the YARA rule. A YARA rule describes a malware family based on a pattern using a set of strings and Boolean logic.</p></div><div id="Structure-of-a-YARA-Rule"><div><h2>Structure of a YARA Rule</h2></div><div><p>Yara rules are compsed by <strong>name</strong>, <strong>meta</strong>, <strong>strings</strong>, and <strong>condition</strong>.</p></div><div><p><strong>Rule Name</strong></p></div><div><p>The Rule name is a descriptive name for the rule and starts with the keyword rule. Best practices include setting a name that clarifies what the rule is used for.</p></div><div><p><strong>Meta</strong></p></div><div><p>This part defines extra information like description, author, and more. Custom identifiers and value pairs can be freely created. The information defined in meta cannot be used in the condition part. Whether to include this part or not is entirely up to you. The rule will work completely fine without it. It is, however, recommended to include the meta part with some basic information, including the author and the description of what to use the rule for.</p></div><div><p><strong>Strings</strong></p></div><div><p>In this part of the rule, matching strings are defined. Multiple types of strings can be defined, which is essential for creating functional rules.</p></div><div><p><strong>Condition</strong></p></div><div><p>In this part of the rule, a matching condition is defined using the identifiers defined in the strings part.</p></div></div></div><div id="Example-of-a-YARA-Rule"><div><h1><span style="color:#da1953">Exa</span>mple of a YARA Rule</h1></div><div><p><strong>Rule name</strong>: M_APT_Dropper_Rootsaw_Obfuscated. The rule’s title is well-chosen and gives the user a good idea of what to use it for. In this case, it is to detect a dropper called Rootsaw that is obfuscated.</p></div><div><p><strong>Meta</strong>: It is good practice to include relevant data that provides more information about the rule. This helps the user of the YARA rule know what to use the rule for, who wrote it, and where to apply it.</p></div><div><p><strong>Strings</strong>: The strings included in this example help the user find a file containing those strings. How do malware analysts choose those strings? They analyze the malware and determine what uniquely identifies it. The strings used are text strings. The first two lines are straightforward.</p></div><div><p><strong>Condition</strong>: This rule requires that all defined strings be present to have a match. This means all the strings defined in part 3 must have a match in the same file being matched against.</p></div><div><p><img src="/cyber/writeup/threathuntingwithyara/093256bb495d401999c533781793f3ce.png"></p></div><div id="Answer-the-questions-below-pt.3"><div><h2>Answer the questions below</h2></div><div><p><b>Q:</b> <i>Apart from the rule name, which other section is also required in a YARA rule?</i><br><b>A:</b> <i>condition</i></p></div></div></div><div id="Yara-Strings-and-Conditions"><div><h1><span style="color:#da1953">Yar</span>a Strings and Conditions</h1></div><div id="False-positives"><div><h2>False positives</h2></div><div><p>An important part of threat hunting is avoiding false alarms. With YARA, this means writing rules that accurately detect the specific threat. However, writing good YARA rules can be tricky and complicated, especially for specific malware. You have two options:</p></div><div><p><ul><li>Learn to write detailed YARA rules yourself.</li><li>Use rules made by experts (like those from threat intelligence reports).</li></ul><p>You can also combine both approaches. Even if you use pre-made rules, it’s important to understand how they work.</p></div><div id="Strings"><div><h4>Strings</h4></div><div><p><strong>Text String</strong></p></div><div><p>Strings are case sensitive.</p></div><div><pre class="yara"><br><span class="rulename">rule textString</span><br>{<br>  <span class="section">strings:</span><br>    <span class="key">$1</span> = <span class="string">"This is an ASCII-encoded string"</span> <span class="comment">//strings are defined between double quotes</span><br>    <span class="key">$2</span> = <span class="string">"This is an ascii-encoded string"</span> <span class="comment">//not the same as $1.</span><br><br>  <span class="section">condition:</span><br>    <span class="condition">all of them</span><br>}<br></pre><br></div><div><pre class="yara"><br><span class="rulename">rule noCaseTextString</span><br>{<br>    <span class="section">strings:</span> <br>      <span class="key">$1</span> = <span class="string">"This is an ASCII-encoded string"</span> <span class="key">nocase</span><br>    <br>    <span class="section">condition:</span>  <br>      <span class="key">$1</span><br>}<br></pre></div><div><p><b>Wide-Character Strings</b></p></div><div>Used for special encoded strings. It is possible to use a modifier next to the defined string so the rule matches for this wide-character string. In this case the modifier used is <b>wide</b>.</div><div><pre class="yara"><br><span class="rulename">rule wideTextString</span><br>{<br>    <span class="section">strings:</span> <br>      <span class="key">$1</span> = <span class="string">"tryhackme"</span> <span class="key">wide</span>      <span class="comment">// will match with t\x00r\x00y\x00h\x00a\x00c\x00k\x00m\x00e\x00</span><br>    <br>    <span class="section">condition:</span>  <br>      <span class="key">$1</span><br>}<br></pre></div><div><p><strong>Hexadecimal String</strong></p></div><div><p>When malware analysts study malware, they use tools like IDA Pro to break down the code, which often appears in hexadecimal format. These hexadecimal strings can be used to create YARA rules because they are harder for attackers to hide or change. This makes them a reliable way to identify specific malicious files.</p></div><div><pre class="yara"><br><span class="rulename">rule hexString</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="hex">{ E2 34 B6 C8 A3 FB }</span> <span class="comment">// Hexadecimal strings are defined between {}</span><br>    <br>    <span class="section">condition:</span><br>      <span class="key">$1</span><br>}<br></pre><br></div><div><pre class="yara"><br><span class="rulename">rule hexStringExpanded</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="hex">{ E2 34 B6 ?? A3 FB }</span> <span class="comment">// The ? is a wildcard and can represent any hex value.</span><br>      <span class="key">$2</span> = <span class="hex">{ E2 34 B6 ~00 A3 FB }</span> <span class="comment">// The ~ is a not operator that precedes the value to exclude from the search. In this case 00.</span><br>      <span class="key">$3</span> = <span class="hex">{ E2 34 [2-4] A3 FB }</span> <span class="comment">// The [X-Y] construct defines a jump. This means that any value between 2 and 4 bytes can occupy this position.</span><br>      <span class="key">$4</span> = <span class="hex">{ E2 34 (C5|B5) A3 FB }</span> <span class="comment">// Between () alternative byte sequences can be defined separated with the boolean operator OR. The value can be B5 OR C5.</span><br>    <br>    <span class="section">condition:</span><br>      <span class="key">$1</span><br>}<br></pre></div><div><p><strong>XOR String</strong></p></div><div><p>Malware creators use XOR encryption to hide their code, making it harder for analysts to analyze and avoid detection by antivirus software. YARA helps by detecting these encrypted strings, even when the encryption uses 1-byte keys.</p></div><div><pre class="yara"><br><span class="rulename">rule xorString</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"http://maliciousurl.thm"</span> <span class="key">xor</span> <span class="comment">// This line will look for all variations possible with a 1-byte XOR key</span><br>    <br>    <span class="section">condition:</span><br>      <span class="key">$1</span><br>}<br></pre><br></div><div><pre class="yara"><span class="rulename">rule base64String</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"This is a regular string"</span> <span class="key">base64</span> <span class="comment">// At runtime YARA will encode the string with base64 and look for matches.</span><br><br>    <span class="section">condition:</span><br>     <span class="key">$1</span><br>}<br></pre></div><div><p><strong>Regular Expressions</strong></p></div><div><p>You can define regular expressions the same way as strings, with the only difference being forward slashes instead of double quotes.</p></div><div><pre class="yara"><span class="rulename">rule regularExpression</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">/THM\{[a-zA-Z]{3}\}/</span> <span class="comment">// This regex will match any string that starts with "THM{", ends with "}" and has 3 alphabetic characters (lower-case or upper-case) between the curly brackets.</span><br><br>    <span class="section">condition:</span><br>      <span class="key">$1</span><br>}<br></pre><br></div></div></div></div><div id="Conditions"><div><h1><span style="color:#da1953">Con</span>ditions</h1></div><div><br></div><div><table ><thead ><tr ><th >Boolean operators</th><th >Relational operators</th><th >Arithmetic operators</th><th >Bitwise operators</th><th >Keywords</th></tr></thead><tbody ><tr ><td >and</td><td >&gt;=</td><td >+</td><td >&amp;</td><td >1 of them</td></tr><tr ><td >or</td><td >&lt;=</td><td >-</td><td >|</td><td >any of them</td></tr><tr ><td >not</td><td >&lt;</td><td >*</td><td >&lt;&lt;</td><td >none of them</td></tr><tr ><td ></td><td >&gt;</td><td >\</td><td >&gt;&gt;</td><td >contains</td></tr><tr ><td ></td><td >==</td><td >%</td><td >~</td><td >icontains</td></tr><tr ><td ></td><td >!=</td><td ></td><td >^</td><td >startswith</td></tr><tr ><td ></td><td ></td><td ></td><td ></td><td >istartswith</td></tr><tr ><td ></td><td ></td><td ></td><td ></td><td >endswith</td></tr><tr ><td ></td><td ></td><td ></td><td ></td><td >iendswith</td></tr><tr ><td ></td><td ></td><td ></td><td ></td><td >iequals</td></tr><tr ><td ></td><td ></td><td ></td><td ></td><td >matches</td></tr><tr ><td ></td><td ></td><td ></td><td ></td><td >not defined</td></tr><tr ><td ></td><td ></td><td ></td><td ></td><td >filesize</td></tr></tbody></table></div><div><p>Some examples:</p></div><div><pre class="yara"><span class="rulename">rule differentConditions</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"Try"</span><br>      <span class="key">$2</span> = <span class="string">"Hack"</span><br>      <span class="key">$3</span> = <span class="string">"Me"</span><br>    <span class="section">condition:</span><br>      <span class="key">all</span> <span class="key">of</span> <span class="key">them</span> <span class="comment">// Matches when all defined strings are present.</span><br>}<br></pre><br></div><div><pre class="yara"><span class="rulename">rule differentConditions</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"Try"</span><br>      <span class="key">$2</span> = <span class="string">"Hack"</span><br>      <span class="key">$3</span> = <span class="string">"Me"</span><br>    <span class="section">condition:</span><br>      <span class="key">any</span> <span class="key">of</span> <span class="key">them</span> <span class="comment">// Matches when at least one of the defined strings is present.</span><br>}<br></pre><br></div><div><pre class="yara"><span class="rulename">rule differentConditions</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"Try"</span><br>      <span class="key">$2</span> = <span class="string">"Hack"</span><br>      <span class="key">$3</span> = <span class="string">"Me"</span><br>    <span class="section">condition:</span><br>      <span class="key">1</span> <span class="key">of</span> <span class="string">$(*)</span> <span class="comment">// Identical to "any of them" condition.</span><br>}<br></pre><br></div><div><pre class="yara"><span class="rulename">rule differentConditions</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"Try"</span><br>      <span class="key">$2</span> = <span class="string">"Hack"</span><br>      <span class="key">$3</span> = <span class="string">"Me"</span><br>    <span class="section">condition:</span><br>      <span class="string">"$1 or $2"</span> <span class="comment">// Matches when 'Try' or 'Hack' is present.</span><br>}<br></pre></div><div><p><span style="color:#FFC107">In the example above, it seems there is an error as the condition in quotes and the next one is not. I have to verify if the quotes changes the behavior or is intended.</span></p></div><div><pre class="yara"><span class="rulename">rule differentConditions</span><br>{<br>    <span class="section">strings:</span><br>        <span class="key">$1</span> = <span class="string">"Try"</span><br>        <span class="key">$2</span> = <span class="string">"Hack"</span><br>        <span class="key">$3</span> = <span class="string">"Me"</span><br>    <span class="section">condition:</span><br>        <span class="key">$1</span> <span class="key">and</span> <span class="key">$2</span> <span class="comment">// Matches when 'Try' and 'Hack' are present.</span><br>}<br></pre><br></div><div><pre class="yara"><span class="rulename">rule differentConditions</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"Try"</span><br>      <span class="key">$2</span> = <span class="string">"Hack"</span><br>      <span class="key">$3</span> = <span class="string">"Me"</span><br>    <span class="section">condition:</span><br>      <span class="key">$1</span> <span class="key">and</span> (<span class="key">$2</span> <span class="key">or</span> <span class="key">$3</span>) <span class="comment">// Matches when 'Try' and 'Hack' or 'Try' and 'Me' combinations are present.</span><br>}<br></pre><br></div><div><pre class="yara"><span class="rulename">rule differentConditions</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"Try"</span><br>      <span class="key">$2</span> = <span class="string">"Hack"</span><br>      <span class="key">$3</span> = <span class="string">"Me"</span><br>    <span class="section">condition:</span><br>      <span class="key">none</span> <span class="key">of</span> <span class="key">them</span> <span class="comment">// Matches only when none of the defined strings are present.</span><br>}<br></pre><br></div><div><pre class="yara"><span class="rulename">rule differentConditions</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"Try"</span><br>      <span class="key">$2</span> = <span class="string">"Hack"</span><br>      <span class="key">$3</span> = <span class="string">"Me"</span><br>    <span class="section">condition:</span><br>      <span class="key">filesize</span> <span class="key">&lt;</span> <span class="key">500KB</span> <span class="comment">// Matches all files smaller than 500 KiloByte. This can only be used when matching for files.</span><br>}<br></pre><br></div><div><pre class="yara"><span class="rulename">rule differentConditions</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"Try"</span><br>      <span class="key">$2</span> = <span class="string">"Hack"</span><br>      <span class="key">$3</span> = <span class="string">"Me"</span><br>    <span class="section">condition:</span><br>      (<span class="key">$1</span> <span class="key">or</span> <span class="key">$2</span>) <span class="key">and</span> <span class="key">filesize</span> <span class="key">&lt;</span> <span class="key">200KB</span> <span class="comment">// Matches for 'Try' or 'Hack' in files smaller than 200KB.</span><br>}<br></pre><br></div><div id="Answer-the-questions-below-pt.4"><div><h2>Answer the questions below</h2></div><div><p><b>Q:</b> <i>What modifier should be used if you want to search for 2-byte encoded characters?</i><br><b>A:</b> <i>wide</i></p></div><div><p><b>Q:</b> <i>What condition should be used if you want to exclude the defined strings from the matching process?</i><br><b>A:</b> <i>none of them</i></p></div></div></div><div id="Basic-Syntax-for-YARA"><div><h1><span style="color:#da1953">Bas</span>ic Syntax for YARA</h1></div><div><p>Execute Yara rules with <code>yara64</code>.</p></div><div><pre class="powershell">PS C:\TMP> yara64<br>yara: wrong number of arguments  # Red text (error)<br>Usage: yara [OPTION]... [NAMESPACE:]RULES_FILE... FILE | DIR | PID  # Cyan text (help/usage)<br>Try `--help` for more options  # Cyan text (help)</pre></div><div><p>Use the argument <code>--help</code> to see the available options.</p></div><div><table>  <tbody><tr>    <th>Short Flag</th>    <th>Long Flag</th>    <th>Description</th>  </tr>  <tr>    <td>-r</td>    <td>--recursive</td>    <td>Scan directories recursively</td>  </tr>  <tr>    <td>-n</td>    <td>--negate</td>    <td>Print only rules that weren't matched</td>  </tr>  <tr>    <td>-S</td>    <td>--print-stats</td>    <td>Print metadata related to the performance and efficiency of the rule</td>  </tr>  <tr>    <td>-s</td>    <td>--print-strings</td>    <td>Print the strings that were matched in a file</td>  </tr>  <tr>    <td>-X</td>    <td>--print-xor-key</td>    <td>Print xor key and plaintext of matched strings</td>  </tr>  <tr>    <td>-v</td>    <td>--version</td>    <td>Show the YARA version</td>  </tr>  <tr>    <td>-p</td>    <td>--threads=N</td>    <td>Use N threads to scan a directory</td>  </tr></tbody></table><br></div><div id="Run-a-YARA-Rule-for-the-First-Time"><div><h2>Run a YARA Rule for the First Time<h2></div><div><br><pre class="powershell-code">PS C:\TMP&gt;<span class="cmdlet">get-content</span> C:\TMP\YARARULES\myfirstrule.yar<br>rule myfirstrule <br>{<br>    meta:<br>        Description = "Searches for the string tryhackme"<br>        Author = "TryHackMe"<br>    <br>    strings:<br>        $s = "tryhackme"<br> <br>    condition:<br>        $s<br>}<br></pre></div><div><p>This rule searches for the string <em>tryhackme</em> in the give directory as argument. For example if the target directory where I want to search is <code>C:\TMP</code> I have to run the following command.</p></div><div><pre class="powershell-code">PS C:\TMP> <span class="cmdlet">yara64</span> C:\TMP\YARARULES\myfirstrule.yar C:\TMP\<br>myfirstrule C:\TMP\test.txt</pre><br></div><div><p>The result shows that the string matches inside the file <code>C:\TMP\test.txt</code></p></div></div><div id="Combine-Multiple-Rules-in-One-File"><div><h2>Combine Multiple Rules in One File</h2></div><div><p>Putting multiple YARA rules in one file can make things easier, especially when they focus on the same malware, campaign, or purpose. For example, if you’re tracking a malware family with different versions, having all the rules in one file keeps everything organized and easier to use. The same goes for investigating a phishing campaign—grouping rules for emails, payloads, and domains into one file makes the process smoother.</p></div><div><p>On the other hand, if the rules are unrelated, it’s better to keep them in separate files. This avoids confusion and makes updates easier. The idea is simple: combine rules that share a common goal to keep things clear and efficient, but don’t lump everything together just for the sake of it.</p></div><div><pre class="yara"><span class="rulename">rule M_APT_Downloader_WINELOADER_1</span><br>{<br>    <span class="section">meta:</span><br>      <span class="key">author</span> = <span class="string">"Mandiant"</span><br>      <span class="key">disclaimer</span> = <span class="string">"This rule is meant for hunting and is not tested to run in a production environment."</span><br>      <span class="key">description</span> = <span class="string">"Detects rc4 decryption logic in WINELOADER samples"</span><br><br>    <span class="section">strings:</span><br>      <span class="key">$</span> = <span class="hex">{B9 00 01 00 00 99 F7 F9 8B 44 24 [50-200] 0F B6 00 3D FF 00 00 00}</span> <span class="comment">// Key initialization</span><br>      <span class="key">$</span> = <span class="hex">{0F B6 00 3D FF 00 00 00}</span> <span class="comment">// Key size</span><br><br>    <span class="section">condition:</span><br>      <span class="condition">all of them</span><br>}<br><br><span class="rulename">rule M_APT_Downloader_WINELOADER_2</span><br>{<br>    <span class="section">meta:</span><br>      <span class="key">author</span> = <span class="string">"Mandiant"</span><br>      <span class="key">disclaimer</span> = <span class="string">"This rule is meant for hunting and is not tested to run in a production environment."</span><br>      <span class="key">description</span> = <span class="string">"Detects payload invocation stub in WINELOADER"</span><br><br>    <span class="section">strings:</span><br><br>      <span class="comment">// 48 8D 0D ?? ?? 00 00  lea rcx, module_start (Pointer to encrypted resource)</span><br>      <span class="comment">// 48 C7 C2 ?? ?? 00 00  mov rdx, ???? (size of encrypted source)</span><br>      <span class="comment">// E8 [4]  call decryption</span><br>      <span class="comment">// 48 8D 05 [4]  lea rcx, ??</span><br>      <span class="comment">// 48 8D 0D [4]  lea rax, module_start (decrypted resource)</span><br>      <span class="comment">// 48 89 05 [4]  mov ptr_mod, rax</span><br><br>      <span class="key">$</span> = <span class="hex">{48 8D 0D ?? ?? 00 00 48 C7 C2 ?? ?? 00 00 E8 [4] 48 8D 0D [4] 48 8D 05 [4] 48 89 05}</span><br><br>    <span class="section">condition:</span><br>      <span class="condition">all of them</span><br>}<br><br><span class="rulename">rule M_APT_Dropper_Rootsaw_Obfuscated</span><br>{<br>    <span class="section">meta:</span><br>      <span class="key">author</span> = <span class="string">"Mandiant"</span><br>      <span class="key">disclaimer</span> = <span class="string">"This rule is meant for hunting and is not tested to run in a production environment."</span><br>      <span class="key">description</span> = <span class="string">"Detects obfuscated ROOTSAW payloads"</span><br><br>    <span class="section">strings:</span><br>      <span class="key">$</span> = <span class="string">"function _"</span><br>      <span class="key">$</span> = <span class="string">"new XMLHttpRequest();"</span><br>      <span class="key">$</span> = <span class="string">'\x2e\x7a\x69\x70'</span><br>      <span class="key">$</span> = <span class="string">'\x4f\x70\x65\x6e'</span><br>      <span class="key">$</span> = <span class="string">"\x43\x3a\x5c\x57"</span><br>      <span class="key">$</span> = <span class="string">"https://waterforvoiceless.org/util.php"</span><br><br>    <span class="section">condition:</span><br>      <span class="condition">2 of them</span><br>}<br></pre><br></div><div></div></div><div id="Answer-the-questions-below-pt.5"><div><h2>Answer the questions below</h2></div><div><p><b>Q:</b> <i>What option do you need to pass to ensure you scan all directories recursively?</i><br><b>A:</b> <i>-r</i></p></div></div></div><div id="Indicators-of-Compromise-Detected"><div><h1><span style="color:#da1953">Ind</span>icators of Compromise Detected</h1></div><div><p>When you find clear evidence of a security problem (called an Indicator of Compromise) on a system, the first thing to do is follow the steps in your company's incident response (IR) plan. A good company will have a document that explains what to do before, during, and after a security incident.</p></div><div><p>Your first step is usually to tell the person or team in charge of handling incidents. They will follow the plan, bring the right people together, and start working on fixing the problem.</p></div><div><p>The plan might include using a system like DAIR (Dynamic Approach to Incident Response) to organize the steps. You might be asked to help with tasks such as looking more closely at the affected computer, saving important evidence, disconnecting the computer from the network, and more.</p></div><div><p><img src="/cyber/writeup/threathuntingwithyara/e339857f7cbe4837933227b7a5c02b1c.png"></p></div><div><p>When you're threat hunting, it’s very important to write down everything you find. This information can be really helpful if there's ever an incident, and it can save time when you start responding to it. Time is very important when dealing with security problems. If you look at the Cyber Kill Chain below, documenting things early could make the difference between catching a problem in the Command and Control (C2) phase or later when the attacker has already started doing damage (Actions on Objectives phase).</p></div><div><p><img src="/cyber/writeup/threathuntingwithyara/89a367f72a384ac692a90544c8d473e2.png"></p></div><div></div></div><div id="YARA:-Hands-on-Exercise"><div><h1><span style="color:#da1953">YAR</span>A: Hands-on Exercise</h1></div><div id="Exercise-1"><div><h2>Exercise 1</h2></div><div><p>Write a YARA rule to find the file that contains the pattern <i>"THM{}"</i>. Use the <code>C:\TMP\Exercise1\</code> path as the target in the YARA command, enter the flag as the answer.</p></div><div><pre class="yara"><span class="rulename">rule exercise1</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"THM{"</span><br><br>    <span class="section">condition:</span><br>      <span class="condition">$1</span><br>}<br></pre></div><div><p>Run as:</p></div><div><pre class="powershell-code">PS C:\TMP\YARARULES> <span class="cmdlet">yara64</span> .\exercise1.yara C:\TMP\Exercise1</pre><br></div></div><div id="Exercise-2"><div><h2>Exercise 2</h2></div><div><p>Write a YARA rule that finds the file that contains the following strings: <i>"Yet another"</i>, "<i>Ridiculous acronym"</i>. Use the <code>C:\TMP\Exercise2\</code> path as the target in the YARA command. Enter the name of the file as the answer.</p></div><div><pre class="yara"><span class="rulename">rule exercise2</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"Yet another"</span> <span class="comment">wide</span><br>      <span class="key">$2</span> = <span class="string">"Ridiculous acronym"</span> <span class="comment">wide</span><br><br>    <span class="section">condition:</span><br>      <span class="condition">$1</span> <span class="condition">and</span> <span class="condition">$2</span><br>}<br></pre></div><div><p>Run as:</p></div><div><pre class="powershell-code">PS C:\TMP\YARARULES> <span class="cmdlet">yara64</span> .\exercise2.yara C:\TMP\Exercise2</pre><br>    </div></div><div id="Exercise-3"><div><h2>Exercise 3</h2></div><div><p>Write a YARA rule that searches for the file that contains the base64 encoded string <i>"THM{This was a really fun exercise}"</i>. Use the <code>C:\TMP\Exercise3\</code> path as the target in the YARA command, and enter name of the file as the answer.</p></div><div><pre class="yara"><span class="rulename">rule exercise3</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"THM{This was a really fun exercise}"</span> <span class="comment">base64</span><br><br>    <span class="section">condition:</span><br>      <span class="condition">$1</span><br>}<br></pre>   </div><div><p>Run as:</p></div><div><pre class="powershell-code">PS C:\TMP\YARARULES> <span class="cmdlet">yara64</span> .\exercise3.yara C:\TMP\Exercise3</pre><br></div></div><div id="Exercise-4"><div><h2>Exercise 4</h2></div><div><p>Write a YARA rule that searches for the XOR encrypted string <i>"THM{FoundSomethingHidden}"</i> in the <code>C:\TMP</code> directory and subdirectories. Fill in the encrypted text and XOR key used.</p></div><div><pre class="yara"><span class="rulename">rule exercise4</span><br>{<br>    <span class="section">strings:</span><br>      <span class="key">$1</span> = <span class="string">"THM{FoundSomethingHidden}"</span> <span class="comment">xor</span><br><br>    <span class="section">condition:</span><br>      <span class="condition">$1</span><br>}<br></pre></div><div><p>Run as:</p></div><div><pre class="powershell-code">PS C:\TMP\YARARULES> <span class="cmdlet">yara64</span> .\exercise4.yara -X C:\TMP\Exercise4</pre><br></div></div><div id="Answer-the-questions-below-pt.6"><div><h2>Answer the questions below</h2></div><div><p><b>Q:</b> <i>What is the flag found in exercise 1?</i><br><b>A:</b> <i>THM{Threathuntingisawesome}</i></P></div><div><p><b>Q:</B> <i>What is the filename found in exercise 2? (Format: filename.extension)</i><br><b>A:</b> <i>file10.txt</i></P></div><div><p><b>Q:</B> <i>What is the filename found in exercise 3? (Format: filename.extension)</i><br><b>A:</b> <i>file13.txt</i></P></div><div><p><b>Q:</B> <i>What was the XOR key used for encryption in exercise 4?</i><br><b>A:</b> <i>0x01</i></P></div><div><p><b>Q:</B> <i>What encrypted string did you find in exercise 4?</i><br><b>A:</b> <i>UILzGntoeRnlduihofIheedo|</i></P></div></div></div></div> </div></div></div><div class="sidebarRight"><div class="sidebarRightChild"><h2>Index</h2><div></div><br/><h2>Tags</h2><div class="tags"><a style="margin-top:10px" href="/cyber/tags/?searchTag=blue+team"><my-tag>blue team</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=investigation"><my-tag>investigation</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=ioc"><my-tag>ioc</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=malware"><my-tag>malware</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=malware+detection"><my-tag>malware detection</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=medium"><my-tag>medium</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=thm"><my-tag>thm</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=threat+hunting"><my-tag>threat hunting</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=walktrough"><my-tag>walktrough</my-tag></a><a style="margin-top:10px" href="/cyber/tags/?searchTag=yara"><my-tag>yara</my-tag></a></div></div></div></div><script src="/_next/static/chunks/webpack-6bf358eca9a0310b.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[5244,[],\"\"]\n3:I[3866,[],\"\"]\n4:I[3108,[\"667\",\"static/chunks/4bd22374-02665d04d05c313a.js\",\"173\",\"static/chunks/173-546eff084523247c.js\",\"541\",\"static/chunks/541-ed6782f5dfc7fbce.js\",\"699\",\"static/chunks/699-ca7eb7733d3ff9ab.js\",\"157\",\"static/chunks/app/cyber/writeup/threat-hunting-with-yara/page-59e96a94b9ce46ef.js\"],\"default\"]\n5:I[5897,[\"667\",\"static/chunks/4bd22374-02665d04d05c313a.js\",\"173\",\"static/chunks/173-546eff084523247c.js\",\"541\",\"static/chunks/541-ed6782f5dfc7fbce.js\",\"699\",\"static/chunks/699-ca7eb7733d3ff9ab.js\",\"157\",\"static/chunks/app/cyber/writeup/threat-hunting-with-yara/page-59e96a94b9ce46ef.js\"],\"default\"]\n6:I[8845,[\"667\",\"static/chunks/4bd22374-02665d04d05c313a.js\",\"173\",\"static/chunks/173-546eff084523247c.js\",\"541\",\"static/chunks/541-ed6782f5dfc7fbce.js\",\"699\",\"static/chunks/699-ca7eb7733d3ff9ab.js\",\"157\",\"static/chunks/app/cyber/writeup/threat-hunting-with-yara/page-59e96a94b9ce46ef.js\"],\"default\"]\n7:I[6213,[],\"OutletBoundary\"]\n9:I[6213,[],\"MetadataBoundary\"]\nb:I[6213,[],\"ViewportBoundary\"]\nd:I[4835,[],\"\"]\n:HL[\"/_next/static/css/89fdb76f795b0797.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"W0UZMGYOycfG1iB6RPRBd\",\"p\":\"\",\"c\":[\"\",\"cyber\",\"writeup\",\"threat-hunting-with-yara\",\"\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"cyber\",{\"children\":[\"writeup\",{\"children\":[\"threat-hunting-with-yara\",{\"children\":[\"__PAGE__\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]}]]}],{\"children\":[\"cyber\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"cyber\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"writeup\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"cyber\",\"children\",\"writeup\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"threat-hunting-with-yara\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L2\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"cyber\",\"children\",\"writeup\",\"children\",\"threat-hunting-with-yara\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L3\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[[\"$\",\"div\",null,{\"className\":\"Wrapper\",\"children\":[[\"$\",\"$L4\",null,{}],[\"$\",\"div\",null,{\"className\":\"content\",\"children\":[\"$\",\"div\",null,{\"className\":\"Post\",\"children\":[\"$\",\"$L5\",null,{\"postname\":\"writeupdb/threat-hunting-with-yara.json\"}]}]}],[\"$\",\"$L6\",null,{\"postname\":\"writeupdb/threat-hunting-with-yara.json\"}]]}],[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/89fdb76f795b0797.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L7\",null,{\"children\":\"$L8\"}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"pVHTjfF3-aamIbKYLUts8\",{\"children\":[[\"$\",\"$L9\",null,{\"children\":\"$La\"}],[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\na:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"link\",\"1\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}]]\n"])</script><script>self.__next_f.push([1,"8:null\n"])</script></body></html>